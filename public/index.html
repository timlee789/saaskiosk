<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Collegiate Grill Photo Booth</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Montserrat:wght@600;800&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background-color: #111; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #webcam { display: none; }
        #output_canvas { display: block; width: 100vw; height: 100vh; object-fit: cover; }

        /* ë©”ì¸ íƒ€ì´í‹€ (ê²€ì€ìƒ‰ í…Œë‘ë¦¬) */
        #main-title {
            position: absolute; top: 20px; width: 100%; left: 0;
            color: rgba(255, 255, 255, 0.9);
            font-family: 'Great Vibes', cursive; font-size: 70px; font-weight: normal;
            text-align: center; z-index: 50; line-height: 1; pointer-events: none;
            text-shadow: -0.5px -0.5px 0 #000, 0.5px -0.5px 0 #000, -0.5px 0.5px 0 #000, 0.5px 0.5px 0 #000;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´ */
        #nav-container {
            position: absolute; left: 30px; top: 55%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 30px; z-index: 200;
        }
        .nav-btn {
            background: linear-gradient(135deg, rgba(255, 153, 51, 0.15), rgba(230, 74, 25, 0.15));
            color: white; padding: 20px 10px; border-radius: 25px; border: 2px solid rgba(255, 200, 100, 0.3);
            font-family: 'Montserrat', sans-serif; font-size: 28px; font-weight: 800;
            cursor: pointer; box-shadow: 0 8px 20px rgba(200, 80, 0, 0.2), inset 0 2px 5px rgba(255,255,255,0.1);
            transition: 0.3s; backdrop-filter: blur(5px); text-align: center; width: 280px;
            display: flex; justify-content: center; align-items: center;
        }
        .nav-btn:hover { transform: scale(1.08); background: linear-gradient(135deg, rgba(255, 180, 80, 0.3), rgba(255, 90, 40, 0.3)); }
        .nav-btn.active {
            background: linear-gradient(135deg, rgba(255, 140, 0, 0.4), rgba(255, 69, 0, 0.4));
            border-color: rgba(255, 247, 0, 0.6); box-shadow: 0 0 25px rgba(255, 140, 0, 0.5); transform: scale(1.05);
        }

        /* í‚¤ì˜¤ìŠ¤í¬ */
        #kiosk-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: white; z-index: 300; display: none; }
        #kiosk-frame { width: 100%; height: 100%; border: none; }
        #btn-close-kiosk { position: absolute; bottom: 30px; left: 30px; background-color: #ff1a1a; color: white; padding: 15px 30px; border-radius: 15px; border: 2px solid white; font-size: 20px; font-weight: bold; cursor: pointer; z-index: 310; font-family: 'Montserrat', sans-serif; }
        
        /* ìŠ¤ë§ˆì¼ ì½˜í…ŒìŠ¤íŠ¸ UI */
        #smile-ui { display: none; }
        /* [ìˆ˜ì •] ìŠ¤ë§ˆì¼ í—¤ë” ìœ„ì¹˜ë¥¼ ìœ„ë¡œ ì˜¬ë¦¼ (top: 40px) */
        #smile-header { position: absolute; top: 40px; width: 100%; text-align: center; z-index: 55; text-shadow: 0 4px 10px rgba(0,0,0,0.8); }
        #smile-title-text { font-size: 60px; font-weight: 900; color: #ffc107; display: block; margin-bottom: 5px; font-family: 'Montserrat', sans-serif; }
        #smile-sub-text { font-size: 30px; font-weight: bold; color: white; font-family: 'Montserrat', sans-serif; }
        #smile-big-icon { font-size: 70px; display: block; margin-top: 5px; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-20px);} 60% {transform: translateY(-10px);} }
        
        #score-box { position: absolute; bottom: 40px; right: 40px; width: 350px; z-index: 50; background: rgba(0,0,0,0.6); padding: 30px; border-radius: 30px; border: 4px solid white; backdrop-filter: blur(5px); display: flex; flex-direction: column; align-items: center; transform: scale(1.1); }
        #score-label { color: white; font-size: 20px; font-weight: bold; margin-bottom: 5px; font-family: 'Montserrat', sans-serif; }
        #score-value { color: #ffc107; font-size: 90px; font-weight: 900; line-height: 1; text-shadow: 0 0 20px rgba(255, 193, 7, 0.6); }
        #score-msg { color: #00ff00; font-size: 28px; font-weight: bold; margin-top: 15px; min-height: 40px; text-align: center; font-family: 'Montserrat', sans-serif; }
        #graph-bg { width: 100%; height: 20px; background-color: #444; border-radius: 10px; margin-top: 15px; overflow: hidden; border: 2px solid white; }
        #graph-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #ffc107, #ff5722); transition: width 0.1s linear; }

        /* í¬í† ë¶€ìŠ¤ UI */
        #photo-ui { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; z-index: 50; }
        .instruction { color: white; margin-bottom: 25px; text-shadow: 1px 1px 5px #000; text-align: center; font-size: 26px; font-weight: bold; background: none; font-family: 'Montserrat', sans-serif; }
        .hand-icon { font-size: 42px; display: block; margin-bottom: 8px; }
        #btn-shutter { width: 120px; height: 120px; background-color: #ffc107; border-radius: 50%; border: 6px solid white; cursor: pointer; box-shadow: 0 6px 20px rgba(0,0,0,0.6); display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #btn-shutter:active { transform: scale(0.95); }
        #btn-shutter svg { width: 45px; height: 45px; fill: #333; }
        .btn-text { color: #333; font-size: 15px; font-weight: bold; text-transform: uppercase; margin-top: 5px; }

        /* ì˜¤ë²„ë ˆì´ */
        #countdown-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 200px; color: #ffc107; font-weight: 900; text-shadow: 0 0 40px rgba(0,0,0,0.8); display: none; pointer-events: none; z-index: 60; }
        #loading-bar-container { position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); width: 250px; height: 16px; background: rgba(255,255,255,0.3); border-radius: 10px; overflow: hidden; display: none; z-index: 55; border: 2px solid rgba(255,255,255,0.5); }
        #loading-bar { width: 0%; height: 100%; background-color: #ffc107; transition: width 0.1s linear; }

        /* ê²°ê³¼ì°½ */
        #result-modal { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0,0,0,0.95); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 400; }
        #result-image-container { width: 70%; max-width: 800px; border: 10px solid white; background: black; margin-bottom: 20px; box-shadow: 0 0 50px rgba(255,255,255,0.2); }
        #result-image { width: 100%; display: block; }
        #result-controls { display: flex; gap: 40px; }
        .action-btn { padding: 20px 50px; border-radius: 50px; border: none; font-size: 24px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 15px; font-family: 'Montserrat', sans-serif; }
        .btn-retake { background-color: #555; color: white; }
        .btn-save { background-color: #ffc107; color: #333; }

        /* QR ì½”ë“œ ëª¨ë‹¬ */
        #qr-modal { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0,0,0,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 500; }
        #qr-box { background: white; padding: 40px; border-radius: 30px; text-align: center; box-shadow: 0 0 50px rgba(255, 193, 7, 0.5); }
        #qr-image { width: 300px; height: 300px; display: block; margin: 0 auto 20px auto; }
        #qr-text { font-size: 24px; font-weight: bold; color: #333; margin-bottom: 20px; font-family: 'Montserrat', sans-serif; }
        #btn-close-qr { background-color: #333; color: white; padding: 15px 40px; border-radius: 30px; border: none; font-size: 20px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="main-title">The Collegiate Grill Photo Booth</div>

<div id="nav-container">
    <button class="nav-btn active" id="btn-mode-smile">ğŸ˜€ Smile Contest</button>
    <button class="nav-btn" id="btn-mode-kiosk">ğŸ” Kiosk (Food)</button>
    <button class="nav-btn" id="btn-mode-photo">ğŸ“¸ Photo Booth</button>
</div>

<div id="kiosk-container">
    <iframe id="kiosk-frame" src="about:blank"></iframe>
    <button id="btn-close-kiosk">â¬… Back to Menu</button>
</div>

<div id="smile-ui">
    <div id="smile-header">
        <span id="smile-big-icon">ğŸ˜€</span>
        <span id="smile-title-text">SMILE CHALLENGE</span>
        <span id="smile-sub-text">Show me your best smile!</span>
    </div>
    <div id="score-box">
        <span id="score-label">CURRENT SCORE</span>
        <div id="score-value">0</div>
        <div id="graph-bg"><div id="graph-bar"></div></div>
        <div id="score-msg"></div>
    </div>
</div>

<div id="photo-ui" style="display: none;">
    <div class="instruction"><span class="hand-icon">âœ‹</span>Show palm to snap ( Timer 5s )</div>
    <button id="btn-shutter">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8.8c-1.77 0-3.2 1.43-3.2 3.2 0 1.77 1.43 3.2 3.2 3.2s3.2-1.43 3.2-3.2c0-1.77-1.43-3.2-3.2-3.2zm0 4.8c-.88 0-1.6-.72-1.6-1.6s.72-1.6 1.6-1.6 1.6.72 1.6 1.6-.72 1.6-1.6 1.6zM20 4h-3.17L15 2H9L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h4.05l1.83-2h4.24l1.83 2H20v12z"/></svg>
        <span class="btn-text">5s Timer</span>
    </button>
</div>

<div id="countdown-overlay"></div>
<div id="loading-bar-container"><div id="loading-bar"></div></div>
<video id="webcam" playsinline autoplay></video>
<canvas id="output_canvas"></canvas>

<div id="result-modal">
    <div id="result-image-container"><img id="result-image" src="" alt=""></div>
    <div id="result-controls">
        <button class="action-btn btn-retake" id="btn-retake">ğŸ”„ RETAKE</button>
        <button class="action-btn btn-save" id="btn-save">ğŸ“± SAVE & SEND</button>
    </div>
</div>

<div id="qr-modal">
    <div id="qr-box">
        <div id="qr-text">Scan to Download!</div>
        <img id="qr-image" src="" alt="QR Code">
        <div id="qr-status" style="margin-bottom:10px; color:#666;">Generating QR...</div>
        <button id="btn-close-qr">Close</button>
    </div>
</div>

<script type="module">
    import { GestureRecognizer, FaceLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

    const IMGBB_API_KEY = "5a5ebc452e3711b0f1b9b6b0caea05ce"; // <-- API í‚¤ ì…ë ¥ í•„ìˆ˜
    const KIOSK_URL = "https://collegiatekiosk-new.vercel.app/"; 
    
    // Elements
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('output_canvas');
    const ctx = canvas.getContext('2d');
    const mainTitle = document.getElementById('main-title');
    const photoUI = document.getElementById('photo-ui');
    const smileUI = document.getElementById('smile-ui');
    const kioskContainer = document.getElementById('kiosk-container');
    const kioskFrame = document.getElementById('kiosk-frame');
    const btnModePhoto = document.getElementById('btn-mode-photo');
    const btnModeSmile = document.getElementById('btn-mode-smile');
    const btnModeKiosk = document.getElementById('btn-mode-kiosk');
    const btnCloseKiosk = document.getElementById('btn-close-kiosk');
    const btnShutter = document.getElementById('btn-shutter');
    const btnRetake = document.getElementById('btn-retake');
    const btnSave = document.getElementById('btn-save');
    const scoreVal = document.getElementById('score-value');
    const scoreMsg = document.getElementById('score-msg');
    const graphBar = document.getElementById('graph-bar');
    const loadingContainer = document.getElementById('loading-bar-container');
    const loadingBar = document.getElementById('loading-bar');
    const countdownDiv = document.getElementById('countdown-overlay');
    const resultModal = document.getElementById('result-modal');
    const resultImage = document.getElementById('result-image');
    const qrModal = document.getElementById('qr-modal');
    const qrImage = document.getElementById('qr-image');
    const qrStatus = document.getElementById('qr-status');
    const btnCloseQr = document.getElementById('btn-close-qr');
    const navContainer = document.getElementById('nav-container');

    let gestureRecognizer, faceLandmarker;
    let running = false;
    let currentMode = 'smile'; 
    let countdownValue = 0;
    let palmHoldStartTime = 0;
    const PALM_HOLD_DURATION = 1500;
    let celebrated = false; 
    let countdownInterval = null; // íƒ€ì´ë¨¸ ì œì–´ ë³€ìˆ˜

    async function setupAI() {
        try {
            const filesetResolver = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
            gestureRecognizer = await GestureRecognizer.createFromOptions(filesetResolver, {
                baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/gesture_recognizer/gesture_recognizer/float16/1/gesture_recognizer.task", delegate: "GPU" },
                runningMode: "VIDEO"
            });
            faceLandmarker = await FaceLandmarker.createFromOptions(filesetResolver, {
                baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task", delegate: "GPU" },
                outputFaceBlendshapes: true,
                runningMode: "VIDEO",
                numFaces: 1
            });
            startCamera();
        } catch (e) { console.error(e); alert("AI ë¡œë”© ì˜¤ë¥˜. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”."); }
    }

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720, facingMode: "user" } });
            video.srcObject = stream;
            video.onloadeddata = () => { 
                running = true; 
                switchMode('smile');
                requestAnimationFrame(loop); 
            };
        } catch (e) { alert("ì¹´ë©”ë¼ ê¶Œí•œ ì˜¤ë¥˜"); }
    }

    async function loop() {
        if (!running) return;
        if (currentMode === 'kiosk') { requestAnimationFrame(loop); return; }
        if (canvas.width !== window.innerWidth || canvas.height !== window.innerHeight) {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        }
        ctx.save(); ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height); ctx.restore();
        
        // ì¹´ìš´íŠ¸ë‹¤ìš´ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ AI ì‹¤í–‰ (ë©ˆì¶¤ í˜„ìƒ ë°©ì§€)
        if (countdownValue === 0) {
            if (currentMode === 'photo') processPhotoBooth(performance.now());
            else if (currentMode === 'smile') processSmileContest(performance.now());
        }
        
        requestAnimationFrame(loop);
    }

    function processPhotoBooth(now) {
        if (!gestureRecognizer) return;
        const results = gestureRecognizer.recognizeForVideo(video, now);
        let palmDetected = false;
        if (results.gestures.length > 0) {
            const name = results.gestures[0][0].categoryName;
            const score = results.gestures[0][0].score;
            if (name === "Open_Palm" && score > 0.65) palmDetected = true;
        }
        if (palmDetected) {
            if (palmHoldStartTime === 0) { palmHoldStartTime = now; loadingContainer.style.display = 'block'; }
            const elapsedTime = now - palmHoldStartTime;
            const progress = Math.min((elapsedTime / PALM_HOLD_DURATION) * 100, 100);
            loadingBar.style.width = `${progress}%`;
            if (elapsedTime >= PALM_HOLD_DURATION) { 
                palmHoldStartTime = 0; 
                loadingContainer.style.display = 'none'; 
                startCountdown(); // íƒ€ì´ë¨¸ ì‹œì‘
            }
        } else {
            palmHoldStartTime = 0; loadingContainer.style.display = 'none'; loadingBar.style.width = '0%';
        }
    }

    function processSmileContest(now) {
        if (!faceLandmarker) return;
        const results = faceLandmarker.detectForVideo(video, now);
        if (results.faceBlendshapes && results.faceBlendshapes.length > 0) {
            const shapes = results.faceBlendshapes[0].categories;
            const smileLeft = shapes.find(s => s.categoryName === 'mouthSmileLeft')?.score || 0;
            const smileRight = shapes.find(s => s.categoryName === 'mouthSmileRight')?.score || 0;
            let rawScore = ((smileLeft + smileRight) / 2) * 100;
            let score = Math.min(Math.round(rawScore * 1.2), 100);
            scoreVal.innerText = score; graphBar.style.width = `${score}%`;
            if (score >= 90) {
                scoreMsg.innerText = "PERFECT!! ğŸ˜";
                if (!celebrated) { fireConfetti(2.5); celebrated = true; setTimeout(() => { celebrated = false; }, 3000); }
            } else if (score >= 80) {
                scoreMsg.innerText = "Great Smile! ğŸ˜„";
                if (!celebrated && Math.random() > 0.7) { fireConfetti(1.5); celebrated = true; setTimeout(() => { celebrated = false; }, 3000); }
            } else if (score >= 40) scoreMsg.innerText = "Keep Smiling ğŸ™‚";
            else scoreMsg.innerText = "";
        } else { scoreVal.innerText = "0"; graphBar.style.width = "0%"; scoreMsg.innerText = "Show Face"; }
    }

    function fireConfetti(scalar = 1) {
        var duration = 2 * 1000; var animationEnd = Date.now() + duration;
        var defaults = { startVelocity: 30 * scalar, spread: 360, ticks: 100, zIndex: 999 };
        var random = function(min, max) { return Math.random() * (max - min) + min; };
        var interval = setInterval(function() {
            var timeLeft = animationEnd - Date.now(); if (timeLeft <= 0) return clearInterval(interval);
            var particleCount = (50 * scalar) * (timeLeft / duration);
            confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.1, 0.3), y: Math.random() - 0.2 } }));
            confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.7, 0.9), y: Math.random() - 0.2 } }));
        }, 200);
    }

    function switchMode(mode) {
        currentMode = mode;
        photoUI.style.display = 'none'; smileUI.style.display = 'none'; kioskContainer.style.display = 'none';
        btnModePhoto.classList.remove('active'); btnModeSmile.classList.remove('active'); btnModeKiosk.classList.remove('active');
        if (mode === 'photo') {
            photoUI.style.display = 'flex'; mainTitle.style.display = 'block'; btnModePhoto.classList.add('active');
        } else if (mode === 'smile') {
            smileUI.style.display = 'block'; mainTitle.style.display = 'none'; btnModeSmile.classList.add('active');
        } else if (mode === 'kiosk') {
            if (kioskFrame.src === 'about:blank' || kioskFrame.src === '') kioskFrame.src = KIOSK_URL;
            kioskContainer.style.display = 'block'; btnModeKiosk.classList.add('active');
        }
    }

    // [ìˆ˜ì •] íƒ€ì´ë¨¸ ë©ˆì¶¤ í˜„ìƒ ìˆ˜ì •ëœ ë²„ì „
    function startCountdown() {
        if (countdownValue > 0) return; // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
        
        countdownValue = 5; 
        countdownDiv.style.display = 'block'; 
        countdownDiv.innerText = countdownValue;
        
        // UI ìˆ¨ê¸°ê¸°
        photoUI.style.display = 'none'; 
        navContainer.style.display = 'none'; 

        // ê¸°ì¡´ íƒ€ì´ë¨¸ê°€ ìˆë‹¤ë©´ ì œê±°
        if (countdownInterval) clearInterval(countdownInterval);

        countdownInterval = setInterval(() => {
            countdownValue--; 
            if (countdownValue > 0) {
                countdownDiv.innerText = countdownValue;
            } else {
                clearInterval(countdownInterval); // íƒ€ì´ë¨¸ ì¢…ë£Œ
                takePhoto();
            }
        }, 1000);
    }

    function takePhoto() {
        countdownDiv.style.display = 'none'; 
        resultImage.src = canvas.toDataURL('image/png'); 
        resultModal.style.display = 'flex';
    }

    function resetCamera() {
        resultModal.style.display = 'none'; qrModal.style.display = 'none';
        if (currentMode === 'photo') photoUI.style.display = 'flex';
        navContainer.style.display = 'flex'; 
        countdownValue = 0; 
        palmHoldStartTime = 0;
    }

    // [ìˆ˜ì •ëœ QR ìƒì„± ë¡œì§]
    // [ìˆ˜ì •ëœ QR ìƒì„± ë¡œì§: ë¡œì»¬ ì €ì¥ ì œê±°ë¨]
    async function uploadAndShowQR() {
        // [ì‚­ì œë¨] ë¡œì»¬ ì €ì¥ ì½”ë“œ 3ì¤„ ì‚­ì œí•¨
        // const link = document.createElement('a'); link.download = ...
        // link.href = resultImage.src; 
        // link.click(); 

        // API í‚¤ í™•ì¸
        if (IMGBB_API_KEY === "5a5ebc452e3711b0f1b9b6b0caea05ce" || IMGBB_API_KEY.length < 10) { 
            alert("ImgBB API KEYë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; 
        }

        resultModal.style.display = 'none'; 
        qrModal.style.display = 'flex';
        qrStatus.innerText = "Uploading to Cloud..."; 
        qrImage.src = "";

        try {
            const base64Data = resultImage.src.split(',')[1];
            const formData = new FormData(); 
            formData.append("image", base64Data);
            
            // ImgBB ì—…ë¡œë“œ
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
            const data = await response.json();
            
            if (data.success) {
                const uploadedImageUrl = data.data.url;
                
                // í˜„ì¬ íŒŒì¼(index.html)ì´ ìˆëŠ” ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ download.html ê²½ë¡œ ìƒì„±
                // ì˜ˆ: https://your-site.com/camera/index.html -> https://your-site.com/camera
                let currentPath = window.location.href;
                // íŒŒì¼ëª…(index.html)ìœ¼ë¡œ ëë‚œë‹¤ë©´ ì œê±°, í´ë”ëª…ìœ¼ë¡œ ëë‚œë‹¤ë©´ ê·¸ëŒ€ë¡œ ë‘ 
                if (currentPath.endsWith('.html')) {
                    currentPath = currentPath.substring(0, currentPath.lastIndexOf('/'));
                }
                // ëì— ìŠ¬ë˜ì‹œ ì œê±°
                if (currentPath.endsWith('/')) {
                    currentPath = currentPath.slice(0, -1);
                }

                const downloadPageUrl = `${currentPath}/download.html?img=${encodeURIComponent(uploadedImageUrl)}`;
                
                qrStatus.innerText = "Scan to Download!";
                qrImage.src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(downloadPageUrl)}`;
                
            } else {
                qrStatus.innerText = "Upload Failed.";
            }
        } catch (error) { 
            console.error(error);
            qrStatus.innerText = "Connection Error."; 
        }
    }
    btnModePhoto.addEventListener('click', () => switchMode('photo'));
    btnModeSmile.addEventListener('click', () => switchMode('smile'));
    btnModeKiosk.addEventListener('click', () => switchMode('kiosk'));
    btnCloseKiosk.addEventListener('click', () => switchMode('smile'));
    btnShutter.addEventListener('click', startCountdown);
    btnRetake.addEventListener('click', resetCamera);
    btnSave.addEventListener('click', uploadAndShowQR);
    btnCloseQr.addEventListener('click', resetCamera);
    setupAI();
</script>
</body>
</html>